name: Upload Data to S3 from PhantomBuster

on:
  push:
    branches:
      - main

jobs:
  upload-data:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check for Required Secrets
      - name: Check Required Secrets
        run: |
          echo "Checking for required secrets..."
          
          # Define secrets here for testing purposes (replace with GitHub Secrets in production)
          PHANTOMBUSTER_API_KEY="6yYcfWE6vtYMfo7FkkwPCgd4yn851XiTIgwpjudSau0"
          PHANTOM_AGENT_ID="2235977726864334"
          AWS_ACCESS_KEY_ID="AKIA472NH4QZCR7AFFDJ"
          AWS_SECRET_ACCESS_KEY="vQnxbuQFEbNDyPPWNPYUAGCq2mb5yewKgkl9Xda"
          S3_BUCKET_NAME="phantombusterdata"
          
          # Check if PHANTOMBUSTER_API_KEY is set
          if [ -z "$PHANTOMBUSTER_API_KEY" ]; then
            echo "ERROR: PHANTOMBUSTER_API_KEY secret is missing!"
            exit 1
          fi

          # Check if PHANTOM_AGENT_ID is set
          if [ -z "$PHANTOM_AGENT_ID" ]; then
            echo "ERROR: PHANTOM_AGENT_ID secret is missing!"
            exit 1
          fi

          # Check if AWS credentials are set
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "ERROR: AWS credentials are missing!"
            exit 1
          fi

          # Check if S3_BUCKET_NAME is set
          if [ -z "$S3_BUCKET_NAME" ]; then
            echo "ERROR: S3_BUCKET_NAME is missing!"
            exit 1
          fi

          echo "All required secrets are present!"

      # Step 2: Setup AWS CLI
      - name: Setup AWS CLI
        run: |
          # Install AWS CLI if it's not already available
          sudo apt-get install awscli -y
          
          # Configure AWS CLI with the provided credentials
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region us-east-1

      # Step 3: Get Data from PhantomBuster
      - name: Get Data from PhantomBuster
        run: |
          # Example command to execute PhantomBuster agent (replace with actual logic)
          echo "Starting PhantomBuster API call..."

          curl -X POST "https://phantombuster.com/api/v2/agents/$PHANTOM_AGENT_ID/launch" \
            -H "Authorization: Bearer $PHANTOMBUSTER_API_KEY" \
            -d "{}"  # Adjust as needed for the specific agent's requirements

          echo "PhantomBuster data extraction started..."

      # Step 4: Wait for PhantomBuster output (this step may vary based on your agent's behavior)
      - name: Wait for PhantomBuster to finish and Download Data
        run: |
          # Wait for the PhantomBuster agent to finish execution and download the output
          echo "Waiting for PhantomBuster output to be ready..."

          # Assuming PhantomBuster creates a file called 'output_data.json'
          curl -O "https://phantombuster.com/your_phantom_output_link"  # Adjust as needed

          echo "Data downloaded successfully."

      # Step 5: Upload Data to S3
      - name: Upload Data to S3
        run: |
          echo "Uploading data to S3..."

          # Assuming the data is in 'output_data.json', replace with the actual file name
          aws s3 cp output_data.json s3://$S3_BUCKET_NAME/

          echo "Data uploaded to S3 successfully!"

