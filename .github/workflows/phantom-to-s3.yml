name: Sync PhantomBuster Data to S3

on:
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6:00 AM UTC
  workflow_dispatch:     # Allows manual trigger

jobs:
  sync-job:
    runs-on: ubuntu-latest

    env:
      PHANTOMBUSTER_API_KEY: ${{ secrets.PHANTOMBUSTER_API_KEY }}
      PHANTOM_AGENT_ID: ${{ secrets.PHANTOM_AGENT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      AWS_REGION: 'ap-south-1'

    steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v3

    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: üì• Install dependencies
      run: |
        echo "[INFO] Installing dependencies..."
        python -m pip install --upgrade pip
        pip install requests boto3

    - name: üß† Debug: Check secrets loaded
      run: |
        echo "[DEBUG] PHANTOM_AGENT_ID is ${PHANTOM_AGENT_ID}"
        echo "[DEBUG] S3_BUCKET_NAME is ${S3_BUCKET_NAME}"

    - name: üß™ Run PhantomBuster script
      run: |
        set -e
        echo "[INFO] Running PhantomBuster API extraction..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        OUTPUT_FILE="phantombuster_data_$TIMESTAMP.json"

        echo "[DEBUG] Output file will be: $OUTPUT_FILE"

        RESPONSE=$(curl -s -w "%{http_code}" -X GET \
          "https://api.phantombuster.com/api/v2/agents/launch" \
          -H "X-Phantombuster-Key-1: $PHANTOMBUSTER_API_KEY" \
          -G \
          --data-urlencode "id=$PHANTOM_AGENT_ID")

        HTTP_STATUS="${RESPONSE: -3}"
        BODY="${RESPONSE::-3}"

        echo "[DEBUG] API response code: $HTTP_STATUS"
        echo "[DEBUG] API response body: $BODY"

        if [[ "$HTTP_STATUS" -ne 200 ]]; then
          echo "[ERROR] Failed to launch PhantomBuster agent. Status: $HTTP_STATUS"
          exit 1
        fi

        echo "$BODY" > "$OUTPUT_FILE"
        echo "[INFO] PhantomBuster data saved to $OUTPUT_FILE"

    - name: ‚òÅÔ∏è Upload to AWS S3
      run: |
        echo "[INFO] Uploading data to S3..."
        FILE_TO_UPLOAD=$(ls phantombuster_data_*.json | head -n 1)

        if [[ ! -f "$FILE_TO_UPLOAD" ]]; then
          echo "[ERROR] Output file not found: $FILE_TO_UPLOAD"
          exit 1
        fi

        echo "[DEBUG] Uploading $FILE_TO_UPLOAD to bucket $S3_BUCKET_NAME..."

        python3 - <<EOF
import boto3
import os

s3 = boto3.client("s3",
    aws_access_key_id=os.environ["AWS_ACCESS_KEY_ID"],
    aws_secret_access_key=os.environ["AWS_SECRET_ACCESS_KEY"],
    region_name=os.environ["AWS_REGION"]
)

file_name = "$FILE_TO_UPLOAD"
bucket_name = os.environ["S3_BUCKET_NAME"]
object_name = f"phantombuster/{file_name}"

try:
    s3.upload_file(file_name, bucket_name, object_name)
    print(f"[INFO] Uploaded {file_name} to s3://{bucket_name}/{object_name}")
except Exception as e:
    print(f"[ERROR] S3 Upload Failed: {e}")
    exit(1)
EOF
